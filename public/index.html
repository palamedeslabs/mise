<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mise ‚Äî Recipe Importer</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --cream: #F7F3EE;
    --ink: #1A1612;
    --warm-mid: #8B7355;
    --accent: #C84B31;
    --accent-soft: #F0E8E4;
    --border: #E2D9CE;
    --white: #FFFFFF;
    --step-bg: #F2EDE6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--cream); color: var(--ink); font-family: 'DM Sans', sans-serif; font-weight: 300; min-height: 100vh; }

  /* HEADER */
  header { padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: var(--cream); position: sticky; top: 0; z-index: 100; }
  .logo { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; letter-spacing: -0.5px; color: var(--ink); cursor: pointer; }
  .logo span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .nav-btn { padding: 9px 18px; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; border: 1.5px solid var(--border); background: transparent; color: var(--ink); }
  .nav-btn:hover { border-color: var(--ink); }
  .nav-btn.primary { background: var(--ink); color: white; border-color: var(--ink); }
  .nav-btn.primary:hover { background: #2E2620; }
  .nav-btn.accent { background: var(--accent); color: white; border-color: var(--accent); }
  .nav-btn.accent:hover { background: #A33A22; }
  .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--ink); color: white; font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(26,22,18,0.5); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--white); border-radius: 20px; padding: 40px; width: 100%; max-width: 420px; margin: 24px; box-shadow: 0 20px 60px rgba(26,22,18,0.2); animation: fadeUp 0.25s ease both; position: relative; }
  .modal h2 { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; margin-bottom: 6px; }
  .modal p { font-size: 14px; color: var(--warm-mid); margin-bottom: 28px; line-height: 1.5; }
  .modal-close { position: absolute; top: 16px; right: 20px; background: none; border: none; font-size: 22px; color: var(--warm-mid); cursor: pointer; padding: 4px 8px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
  .form-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--warm-mid); font-weight: 500; }
  .form-input { padding: 13px 16px; border: 1.5px solid var(--border); border-radius: 10px; background: var(--cream); font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--ink); outline: none; transition: border-color 0.2s; }
  .form-input:focus { border-color: var(--accent); background: var(--white); }
  .form-submit { width: 100%; padding: 14px; background: var(--ink); color: white; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 500; cursor: pointer; margin-top: 4px; transition: background 0.15s; }
  .form-submit:hover { background: #2E2620; }
  .form-submit:disabled { background: #B0A89C; cursor: not-allowed; }
  .divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: var(--warm-mid); font-size: 12px; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .google-btn { width: 100%; padding: 13px; border: 1.5px solid var(--border); border-radius: 10px; background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--ink); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.15s; }
  .google-btn:hover { border-color: var(--ink); background: var(--cream); }
  .modal-switch { text-align: center; margin-top: 20px; font-size: 13px; color: var(--warm-mid); }
  .modal-switch a { color: var(--accent); cursor: pointer; text-decoration: none; font-weight: 500; }
  .form-error { background: #FEF2F0; border: 1px solid #F5C6BE; color: var(--accent); padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; display: none; }
  .form-error.show { display: block; }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }

  /* IMPORT */
  .import-section { max-width: 720px; margin: 72px auto 0; padding: 0 24px; text-align: center; }
  .import-section h1 { font-family: 'Playfair Display', serif; font-size: clamp(36px, 5vw, 56px); font-weight: 400; line-height: 1.1; letter-spacing: -1px; margin-bottom: 16px; }
  .import-section h1 em { font-style: italic; color: var(--accent); }
  .import-section p { color: var(--warm-mid); font-size: 16px; margin-bottom: 40px; line-height: 1.6; }
  .url-form { display: flex; gap: 12px; max-width: 600px; margin: 0 auto 16px; }
  .url-input { flex: 1; padding: 16px 20px; border: 1.5px solid var(--border); border-radius: 12px; background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--ink); outline: none; transition: border-color 0.2s; }
  .url-input:focus { border-color: var(--accent); }
  .url-input::placeholder { color: #B0A89C; }
  .import-btn { padding: 16px 28px; background: var(--accent); color: white; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: background 0.2s, transform 0.1s; }
  .import-btn:hover { background: #A33A22; }
  .import-btn:active { transform: scale(0.98); }
  .import-btn:disabled { background: #C8B9AE; cursor: not-allowed; }
  .sample-links { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 12px; }
  .sample-link { font-size: 12px; color: var(--warm-mid); background: var(--white); border: 1px solid var(--border); padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: all 0.15s; text-decoration: none; }
  .sample-link:hover { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }

  /* STATUS */
  .status-bar { max-width: 720px; margin: 24px auto 0; padding: 0 24px; display: none; }
  .status-bar.visible { display: block; }
  .status-inner { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; font-size: 14px; color: var(--warm-mid); }
  .spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-bar { background: #FEF2F0; border-color: #F5C6BE; color: var(--accent); }

  /* RECIPE CARD */
  .recipe-card { max-width: 860px; margin: 48px auto 80px; padding: 0 24px; display: none; animation: fadeUp 0.4s ease both; }
  .recipe-card.visible { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
  .card-inner { background: var(--white); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 4px 40px rgba(26,22,18,0.06); }
  .recipe-hero { width: 100%; height: 340px; object-fit: cover; display: block; }
  .recipe-hero-placeholder { width: 100%; height: 220px; background: linear-gradient(135deg, var(--step-bg) 0%, var(--border) 100%); display: flex; align-items: center; justify-content: center; color: var(--warm-mid); font-size: 48px; }
  .card-body { padding: 40px 48px 48px; }
  .recipe-title { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; line-height: 1.2; letter-spacing: -0.5px; color: var(--ink); border: none; background: transparent; outline: none; width: 100%; resize: none; padding: 0; }
  .recipe-title:focus { background: var(--accent-soft); border-radius: 6px; padding: 4px 8px; margin: -4px -8px; }
  .recipe-source { font-size: 12px; color: var(--warm-mid); margin-bottom: 24px; }
  .recipe-source a { color: var(--warm-mid); text-decoration: none; }
  .recipe-source a:hover { color: var(--accent); }
  .meta-row { display: flex; gap: 24px; flex-wrap: wrap; padding: 20px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); margin-bottom: 36px; }
  .meta-item { display: flex; flex-direction: column; gap: 4px; }
  .meta-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--warm-mid); }
  .meta-value { font-size: 15px; font-weight: 500; color: var(--ink); }
  .serving-scaler { display: flex; align-items: center; gap: 8px; }
  .scale-btn { width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--cream); color: var(--ink); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; line-height: 1; }
  .scale-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
  .serving-count { font-size: 18px; font-weight: 500; min-width: 24px; text-align: center; }
  .scale-badge { display: inline-block; background: var(--accent); color: white; font-size: 10px; font-weight: 500; padding: 2px 7px; border-radius: 10px; margin-left: 4px; letter-spacing: 0.04em; }
  .scale-badge.hidden { display: none; }
  .recipe-columns { display: grid; grid-template-columns: 280px 1fr; gap: 48px; align-items: start; }
  .section-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; margin-bottom: 20px; }
  .ingredient-list { list-style: none; display: flex; flex-direction: column; }
  .ingredient-item { padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; align-items: baseline; gap: 10px; font-size: 14px; line-height: 1.4; }
  .ingredient-item:last-child { border-bottom: none; }
  .ingredient-amount { font-weight: 500; color: var(--accent); min-width: 56px; font-size: 13px; flex-shrink: 0; }
  .ingredient-name { color: var(--ink); border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 300; outline: none; width: 100%; padding: 0; }
  .ingredient-name:focus { background: var(--accent-soft); border-radius: 4px; padding: 2px 6px; margin: -2px -6px; }
  .steps-list { list-style: none; display: flex; flex-direction: column; gap: 16px; }
  .step-item { display: flex; gap: 16px; align-items: flex-start; }
  .step-num { width: 28px; height: 28px; border-radius: 50%; background: var(--ink); color: white; font-size: 12px; font-weight: 500; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
  .step-text { font-size: 15px; line-height: 1.65; color: var(--ink); border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-weight: 300; outline: none; width: 100%; resize: none; padding: 0; min-height: 60px; overflow: hidden; }
  .step-text:focus { background: var(--accent-soft); border-radius: 6px; padding: 6px 10px; margin: -6px -10px; }
  .action-bar { margin-top: 40px; padding-top: 28px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
  .btn-secondary { padding: 12px 22px; border: 1.5px solid var(--border); border-radius: 10px; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--ink); cursor: pointer; transition: all 0.15s; }
  .btn-secondary:hover { border-color: var(--ink); background: var(--cream); }
  .btn-primary { padding: 12px 22px; background: var(--ink); color: white; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
  .btn-primary:hover { background: #2E2620; }
  .btn-primary:disabled { background: #B0A89C; cursor: not-allowed; }
  .edit-hint { font-size: 11px; color: var(--warm-mid); text-align: right; margin-bottom: 12px; opacity: 0.7; }

  /* LIBRARY */
  .library-section { max-width: 1000px; margin: 0 auto; padding: 48px 24px 80px; }
  .library-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 36px; }
  .library-header h1 { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; }
  .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
  .recipe-thumb { background: var(--white); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
  .recipe-thumb:hover { transform: translateY(-3px); box-shadow: 0 8px 32px rgba(26,22,18,0.1); }
  .thumb-img { width: 100%; height: 180px; object-fit: cover; display: block; background: var(--step-bg); }
  .thumb-placeholder { width: 100%; height: 180px; background: linear-gradient(135deg, var(--step-bg) 0%, var(--border) 100%); display: flex; align-items: center; justify-content: center; font-size: 36px; }
  .thumb-body { padding: 16px 18px 18px; }
  .thumb-title { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; line-height: 1.3; margin-bottom: 6px; color: var(--ink); }
  .thumb-meta { font-size: 12px; color: var(--warm-mid); display: flex; gap: 12px; }
  .library-empty { text-align: center; padding: 80px 24px; color: var(--warm-mid); }
  .library-empty h2 { font-family: 'Playfair Display', serif; font-size: 24px; margin-bottom: 12px; color: var(--ink); }
  .library-empty p { font-size: 15px; margin-bottom: 28px; }

  /* TOAST */
  .save-toast { position: fixed; bottom: 32px; right: 32px; background: var(--ink); color: white; padding: 14px 22px; border-radius: 12px; font-size: 14px; font-weight: 500; display: none; align-items: center; gap: 10px; box-shadow: 0 8px 32px rgba(26,22,18,0.2); z-index: 200; }
  .save-toast.show { display: flex; animation: slideIn 0.3s ease both; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  @media (max-width: 660px) {
    .recipe-columns { grid-template-columns: 1fr; }
    .card-body { padding: 24px; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo" onclick="showPage('import')">mise<span>.</span></div>
  <div class="header-right" id="headerRight">
    <button class="nav-btn" onclick="showModal('login')">Sign in</button>
    <button class="nav-btn primary" onclick="showModal('signup')">Sign up</button>
  </div>
</header>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="authModal" onclick="closeModalOnBg(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div id="loginForm">
      <h2>Welcome back</h2>
      <p>Sign in to access your saved recipes.</p>
      <div class="form-error" id="loginError"></div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" type="email" id="loginEmail" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="form-submit" id="loginSubmit" onclick="handleLogin()">Sign in</button>
      <div class="divider">or</div>
      <button class="google-btn" onclick="handleGoogleAuth()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.826.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
        Continue with Google
      </button>
      <div class="modal-switch">Don't have an account? <a onclick="switchModal('signup')">Sign up</a></div>
    </div>
    <div id="signupForm" style="display:none">
      <h2>Create account</h2>
      <p>Start saving recipes to your personal collection.</p>
      <div class="form-error" id="signupError"></div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" type="email" id="signupEmail" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" type="password" id="signupPassword" placeholder="Min. 6 characters" />
      </div>
      <button class="form-submit" id="signupSubmit" onclick="handleSignup()">Create account</button>
      <div class="divider">or</div>
      <button class="google-btn" onclick="handleGoogleAuth()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.826.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.166 6.656 3.58 9 3.58z"/></svg>
        Continue with Google
      </button>
      <div class="modal-switch">Already have an account? <a onclick="switchModal('login')">Sign in</a></div>
    </div>
    <div id="confirmForm" style="display:none">
      <h2>Check your email</h2>
      <p>We sent a confirmation link to <strong id="confirmEmail"></strong>. Click it to activate your account, then sign in.</p>
    </div>
  </div>
</div>

<!-- IMPORT PAGE -->
<div class="page active" id="pageImport">
  <section class="import-section">
    <h1>Paste a URL.<br><em>Get just the recipe.</em></h1>
    <p>No life stories. No ads. Just ingredients and steps ‚Äî clean, editable, yours.</p>
    <div class="url-form">
      <input type="url" class="url-input" id="urlInput" placeholder="https://www.allrecipes.com/recipe/..." autocomplete="off" />
      <button class="import-btn" id="importBtn" onclick="importRecipe()">Import</button>
    </div>
    <div class="sample-links">
      <span style="font-size:12px;color:var(--warm-mid);align-self:center;">Try a sample:</span>
      <a class="sample-link" onclick="useSample('https://www.allrecipes.com/recipe/10813/best-chocolate-chip-cookies/')">Chocolate Chip Cookies</a>
      <a class="sample-link" onclick="useSample('https://www.allrecipes.com/recipe/228122/best-pasta-carbonara/')">Pasta Carbonara</a>
      <a class="sample-link" onclick="useSample('https://www.allrecipes.com/recipe/14231/guacamole/')">Guacamole</a>
      <a class="sample-link" onclick="useSample('https://www.allrecipes.com/recipe/87663/slow-cooker-beef-stew/')">Crockpot Beef Stew</a>
    </div>
  </section>
  <div class="status-bar" id="statusBar">
    <div class="status-inner" id="statusInner">
      <div class="spinner" id="statusSpinner"></div>
      <span id="statusText">Fetching recipe‚Ä¶</span>
    </div>
  </div>
  <div class="recipe-card" id="recipeCard">
    <div class="card-inner">
      <div id="heroContainer"></div>
      <div class="card-body">
        <div class="edit-hint">‚úèÔ∏è Click any field to edit</div>
        <textarea class="recipe-title" id="recipeTitle" rows="2" spellcheck="false"></textarea>
        <div class="recipe-source" id="recipeSource"></div>
        <div class="meta-row">
          <div class="meta-item">
            <span class="meta-label">Servings</span>
            <div class="serving-scaler">
              <button class="scale-btn" onclick="changeServings(-1)">‚àí</button>
              <span class="serving-count" id="servingCount">4</span>
              <button class="scale-btn" onclick="changeServings(1)">+</button>
              <span class="scale-badge hidden" id="scaleBadge"></span>
            </div>
          </div>
          <div class="meta-item" id="metaTime" style="display:none">
            <span class="meta-label">Total Time</span>
            <span class="meta-value" id="recipeTime"></span>
          </div>
          <div class="meta-item" id="metaCategory" style="display:none">
            <span class="meta-label">Category</span>
            <span class="meta-value" id="recipeCategory"></span>
          </div>
        </div>
        <div class="recipe-columns">
          <div>
            <div class="section-title">Ingredients</div>
            <ul class="ingredient-list" id="ingredientList"></ul>
          </div>
          <div>
            <div class="section-title">Steps</div>
            <ol class="steps-list" id="stepsList"></ol>
          </div>
        </div>
        <div class="action-bar">
          <button class="btn-secondary" onclick="resetApp()">Import Another</button>
          <button class="btn-primary" id="saveBtn" onclick="saveRecipe()">‚úì Save Recipe</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRARY PAGE -->
<div class="page" id="pageLibrary">
  <div class="library-section">
    <div class="library-header">
      <h1>My Recipes</h1>
      <button class="nav-btn accent" onclick="showPage('import')">+ Import Recipe</button>
    </div>
    <div id="libraryContent"></div>
  </div>
</div>

<div class="save-toast" id="saveToast"></div>

<script>
  // ‚îÄ‚îÄ CONFIG: replace these two values after creating your Supabase project ‚îÄ‚îÄ
  const SUPABASE_URL = 'https://mbzvwuwmpmzspekzzrkm.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ienZ3dXdtcG16c3Bla3p6cmttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NTczNzQsImV4cCI6MjA4NzEzMzM3NH0.jnCn_nUIEmj29ytVpxYv5HQ4hP78CifaCMhsVvZc0F0';
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const { createClient } = window.supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let baseServings = 4;
  let currentServings = 4;
  let baseIngredients = [];
  let currentRecipeData = null;

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
  async function initAuth() {
    const { data: { session } } = await sb.auth.getSession();
    if (session?.user) setUser(session.user);
    sb.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user || null);
      if (session?.user) closeModal();
    });
  }

  function setUser(user) {
    currentUser = user;
    const el = document.getElementById('headerRight');
    if (user) {
      const initial = (user.email || 'U')[0].toUpperCase();
      el.innerHTML = `
        <button class="nav-btn" onclick="showPage('library')">My Recipes</button>
        <div class="user-avatar" title="Sign out" onclick="handleSignOut()">${initial}</div>`;
    } else {
      el.innerHTML = `
        <button class="nav-btn" onclick="showModal('login')">Sign in</button>
        <button class="nav-btn primary" onclick="showModal('signup')">Sign up</button>`;
    }
  }

  async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const btn = document.getElementById('loginSubmit');
    const err = document.getElementById('loginError');
    err.classList.remove('show');
    btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
    const { error } = await sb.auth.signInWithPassword({ email, password });
    btn.disabled = false; btn.textContent = 'Sign in';
    if (error) { err.textContent = error.message; err.classList.add('show'); }
  }

  async function handleSignup() {
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const btn = document.getElementById('signupSubmit');
    const err = document.getElementById('signupError');
    err.classList.remove('show');
    btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
    const { error } = await sb.auth.signUp({ email, password });
    btn.disabled = false; btn.textContent = 'Create account';
    if (error) { err.textContent = error.message; err.classList.add('show'); return; }
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('confirmForm').style.display = 'block';
    document.getElementById('confirmEmail').textContent = email;
  }

  async function handleGoogleAuth() {
    await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
  }

  async function handleSignOut() {
    await sb.auth.signOut();
    showToast('Signed out');
    showPage('import');
  }

  // ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
  function showModal(type) { document.getElementById('authModal').classList.add('show'); switchModal(type); }
  function closeModal() { document.getElementById('authModal').classList.remove('show'); }
  function closeModalOnBg(e) { if (e.target === document.getElementById('authModal')) closeModal(); }
  function switchModal(type) {
    document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
    document.getElementById('signupForm').style.display = type === 'signup' ? 'block' : 'none';
    document.getElementById('confirmForm').style.display = 'none';
  }

  // ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ
  function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
    if (page === 'library') loadLibrary();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
  async function saveRecipe() {
    if (!currentUser) { showModal('login'); showToast('Sign in to save recipes'); return; }
    if (!currentRecipeData) return;
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

    const title = document.getElementById('recipeTitle').value;
    const steps = Array.from(document.querySelectorAll('.step-text')).map(t => t.value);
    const ingredients = baseIngredients.map((ing, i) => {
      const nameEl = document.querySelector(`.ingredient-name[data-idx="${i}"]`);
      return { amount: ing.amountText, name: nameEl ? nameEl.value : ing.name };
    });

    const { error } = await sb.from('recipes').insert({
      user_id: currentUser.id,
      title,
      image_url: currentRecipeData.image || null,
      source_url: currentRecipeData.sourceUrl || null,
      servings: baseServings,
      total_time: currentRecipeData.totalTime || null,
      category: Array.isArray(currentRecipeData.category) ? currentRecipeData.category[0] : (currentRecipeData.category || null),
      ingredients,
      steps
    });

    btn.disabled = false;
    if (error) { showToast('Error: ' + error.message); btn.textContent = '‚úì Save Recipe'; console.error(error); }
    else { showToast('‚úì Saved to your collection'); btn.textContent = '‚úì Saved!'; }
  }

  // ‚îÄ‚îÄ LIBRARY ‚îÄ‚îÄ
  async function loadLibrary() {
    const el = document.getElementById('libraryContent');
    el.innerHTML = '<div style="color:var(--warm-mid);padding:40px 0;text-align:center">Loading‚Ä¶</div>';
    if (!currentUser) {
      el.innerHTML = `<div class="library-empty"><h2>Sign in to see your recipes</h2><p>Create an account to save and access your collection.</p><button class="nav-btn primary" onclick="showModal('login')">Sign in</button></div>`;
      return;
    }
    const { data, error } = await sb.from('recipes').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    if (error) { el.innerHTML = '<p style="color:var(--accent);padding:40px">Error loading recipes.</p>'; return; }
    if (!data.length) {
      el.innerHTML = `<div class="library-empty"><h2>No recipes yet</h2><p>Import your first recipe and save it to build your collection.</p><button class="nav-btn accent" onclick="showPage('import')">+ Import Recipe</button></div>`;
      return;
    }
    el.innerHTML = `<div class="recipe-grid">${data.map(r => `
      <div class="recipe-thumb" onclick='openSavedRecipe(${JSON.stringify(r)})'>
        ${r.image_url ? `<img class="thumb-img" src="${escHtml(r.image_url)}" onerror="this.outerHTML='<div class=\\'thumb-placeholder\\'>üçΩ</div>'" />` : `<div class="thumb-placeholder">üçΩ</div>`}
        <div class="thumb-body">
          <div class="thumb-title">${escHtml(r.title)}</div>
          <div class="thumb-meta">
            ${r.total_time ? `<span>‚è± ${escHtml(formatTime(r.total_time))}</span>` : ''}
            ${r.servings ? `<span>üë§ ${r.servings}</span>` : ''}
            ${r.category ? `<span>${escHtml(r.category)}</span>` : ''}
          </div>
        </div>
      </div>`).join('')}</div>`;
  }

  function openSavedRecipe(r) {
    currentRecipeData = { image: r.image_url, sourceUrl: r.source_url, totalTime: r.total_time, category: r.category };
    showPage('import');
    renderRecipe({ title: r.title, image: r.image_url, servings: r.servings, totalTime: r.total_time, category: r.category, ingredients: r.ingredients, steps: r.steps }, r.source_url || '');
  }

  // ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ
  function useSample(url) { document.getElementById('urlInput').value = url; importRecipe(); }

  function setStatus(msg, isError = false) {
    const bar = document.getElementById('statusBar');
    bar.classList.add('visible');
    document.getElementById('statusText').textContent = msg;
    document.getElementById('statusInner').className = 'status-inner' + (isError ? ' error-bar' : '');
    document.getElementById('statusSpinner').style.display = isError ? 'none' : 'block';
  }
  function hideStatus() { document.getElementById('statusBar').classList.remove('visible'); }

  async function importRecipe() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return;
    document.getElementById('recipeCard').classList.remove('visible');
    document.getElementById('importBtn').disabled = true;
    document.getElementById('saveBtn').textContent = '‚úì Save Recipe';
    setStatus('Fetching recipe page‚Ä¶');

    try {
      let html = '';
      try {
        const r = await fetch('/api/fetch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
        html = (await r.json()).html || '';
      } catch(e) {}

      setStatus('Reading recipe content‚Ä¶');
      const extracted = extractRecipeData(html, url);

      setStatus('Parsing with AI‚Ä¶');
      const cr = await fetch('/api/claude', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: buildPrompt(url, extracted) }) });
      if (!cr.ok) throw new Error((await cr.json()).error || 'Claude API error');

      const text = (await cr.json()).text;
      const recipe = JSON.parse(text.replace(/^```(?:json)?/i, '').replace(/```$/, '').trim());
      recipe.sourceUrl = url;
      renderRecipe(recipe, url);

    } catch(err) {
      setStatus('Could not import. Try another URL. (' + err.message + ')', true);
      console.error(err);
    } finally {
      document.getElementById('importBtn').disabled = false;
    }
  }

  function extractRecipeData(html, url) {
    if (!html) return `URL: ${url}\nNo HTML retrieved.`;
    const ldMatches = html.match(/<script[^>]+type="application\/ld\+json"[^>]*>([\s\S]*?)<\/script>/gi) || [];
    for (const m of ldMatches) {
      const inner = m.replace(/<script[^>]*>/i, '').replace(/<\/script>/i, '').trim();
      try {
        let data = JSON.parse(inner);
        if (data['@graph']) data = data['@graph'];
        if (Array.isArray(data)) data = data.find(d => d['@type'] === 'Recipe' || (Array.isArray(d['@type']) && d['@type'].includes('Recipe')));
        if (!data?.recipeIngredient) continue;
        let steps = [];
        const ins = data.recipeInstructions;
        if (typeof ins === 'string') steps = ins.split(/\n+/).map(s => s.trim()).filter(Boolean);
        else if (Array.isArray(ins)) steps = ins.map(s => typeof s === 'string' ? s.trim() : (s['@type'] === 'HowToSection' ? (s.itemListElement||[]).map(x => x.text||'').join(' ') : (s.text||s.name||''))).filter(Boolean);
        return `Parsed recipe data:\n${JSON.stringify({ name: data.name, image: Array.isArray(data.image) ? data.image[0] : (typeof data.image === 'object' ? data.image.url : data.image), recipeYield: data.recipeYield, totalTime: data.totalTime, recipeCategory: data.recipeCategory, recipeIngredient: data.recipeIngredient, recipeInstructions: steps }, null, 2)}`;
      } catch(e) {}
    }
    return `Page text:\n${html.replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,20000)}`;
  }

  function buildPrompt(url, extracted) {
    return `You are a recipe parser. Return ONLY valid JSON ‚Äî no markdown, no code fences.

URL: ${url}
Content: ${extracted}

Return: {"title":"...","image":"url or null","servings":4,"totalTime":"45 mins or null","category":"Dinner or null","ingredients":[{"amount":"1 cup","name":"flour"}],"steps":["Step one.","Step two."]}

Rules: US units only. Split each ingredient into amount+name. Include ALL steps. Steps as full sentences. servings as number only.`;
  }

  function renderRecipe(recipe, sourceUrl) {
    hideStatus();
    currentRecipeData = { ...recipe, sourceUrl };
    baseServings = recipe.servings || 4;
    currentServings = baseServings;
    baseIngredients = (recipe.ingredients || []).map(ing => ({ ...ing, parsedAmount: parseFloat(ing.amount) || null, amountText: ing.amount || '' }));

    const hero = document.getElementById('heroContainer');
    hero.innerHTML = recipe.image ? `<img class="recipe-hero" src="${escHtml(recipe.image)}" onerror="this.parentElement.innerHTML='<div class=\\'recipe-hero-placeholder\\'>üçΩ</div>'" />` : `<div class="recipe-hero-placeholder">üçΩ</div>`;

    document.getElementById('recipeTitle').value = recipe.title || 'Untitled Recipe';
    try { document.getElementById('recipeSource').innerHTML = `Imported from <a href="${escHtml(sourceUrl)}" target="_blank">${new URL(sourceUrl).hostname.replace('www.','')}</a>`; } catch(e) { document.getElementById('recipeSource').innerHTML = ''; }

    document.getElementById('servingCount').textContent = currentServings;
    document.getElementById('scaleBadge').classList.add('hidden');

    if (recipe.totalTime) { document.getElementById('recipeTime').textContent = formatTime(recipe.totalTime); document.getElementById('metaTime').style.display = 'flex'; } else { document.getElementById('metaTime').style.display = 'none'; }
    if (recipe.category) { const c = Array.isArray(recipe.category) ? recipe.category[0] : recipe.category; document.getElementById('recipeCategory').textContent = c; document.getElementById('metaCategory').style.display = 'flex'; } else { document.getElementById('metaCategory').style.display = 'none'; }

    renderIngredients();
    document.getElementById('stepsList').innerHTML = (recipe.steps || []).map((s, i) => `<li class="step-item"><div class="step-num">${i+1}</div><textarea class="step-text" rows="3" oninput="autoResize(this)">${escHtml(s)}</textarea></li>`).join('');
    document.getElementById('recipeCard').classList.add('visible');
    document.getElementById('recipeCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
    requestAnimationFrame(() => document.querySelectorAll('.step-text, .recipe-title').forEach(autoResize));
  }

  function renderIngredients() {
    const sf = currentServings / baseServings;
    document.getElementById('ingredientList').innerHTML = baseIngredients.map((ing, i) => {
      let amt = ing.amountText;
      if (ing.parsedAmount !== null && sf !== 1) amt = ing.amountText.replace(/[\d¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû]+\.?\d*/g, formatAmount(ing.parsedAmount * sf));
      return `<li class="ingredient-item"><span class="ingredient-amount">${escHtml(amt)}</span><input class="ingredient-name" type="text" value="${escHtml(ing.name)}" data-idx="${i}" /></li>`;
    }).join('');
  }

  function formatAmount(n) {
    if (n === Math.floor(n)) return String(Math.floor(n));
    const whole = Math.floor(n), frac = n - whole;
    for (const [v,s] of [[0.25,'¬º'],[0.33,'‚Öì'],[0.5,'¬Ω'],[0.67,'‚Öî'],[0.75,'¬æ'],[0.125,'‚Öõ'],[0.375,'‚Öú'],[0.625,'‚Öù'],[0.875,'‚Öû']]) {
      if (Math.abs(frac-v) < 0.04) return whole > 0 ? `${whole}${s}` : s;
    }
    return n.toFixed(2).replace(/\.?0+$/,'');
  }

  function formatTime(t) {
    if (!t || !t.startsWith('PT')) return t || '';
    const h = t.match(/(\d+)H/)?.[1], m = t.match(/(\d+)M/)?.[1];
    if (h && m) return `${h}h ${m}m`; if (h) return `${h}h`; if (m) return `${m} mins`; return t;
  }

  function changeServings(delta) {
    const n = currentServings + delta;
    if (n < 1 || n > 100) return;
    currentServings = n;
    document.getElementById('servingCount').textContent = n;
    const badge = document.getElementById('scaleBadge');
    if (n !== baseServings) { badge.textContent = `${(n/baseServings).toFixed(1).replace(/\.0$/,'')}√ó`; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
    renderIngredients();
  }

  function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
  function resetApp() { document.getElementById('recipeCard').classList.remove('visible'); document.getElementById('urlInput').value = ''; currentRecipeData = null; window.scrollTo({ top: 0, behavior: 'smooth' }); }
  function showToast(msg) { const t = document.getElementById('saveToast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2800); }
  function escHtml(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;') : ''; }

  document.getElementById('urlInput').addEventListener('keydown', e => { if (e.key === 'Enter') importRecipe(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  initAuth();
</script>
</body>
</html>
